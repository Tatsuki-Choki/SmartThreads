name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test-frontend:
    name: フロントエンドテスト
    runs-on: ubuntu-latest
    
    defaults:
      run:
        working-directory: ./smartthreads-frontend
        
    steps:
      - name: コードをチェックアウト
        uses: actions/checkout@v4
        
      - name: Node.js環境を設定
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: ./smartthreads-frontend/package-lock.json
          
      - name: 依存関係をインストール
        run: npm ci
        
      - name: TypeScript型チェック
        run: npm run build
        
      - name: ESLintチェック
        run: npm run lint || true
        
  test-backend:
    name: バックエンドテスト
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: testpassword
          POSTGRES_DB: smartthreads_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
          
      redis:
        image: redis:7
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379
    
    defaults:
      run:
        working-directory: ./smartthreads-backend
        
    steps:
      - name: コードをチェックアウト
        uses: actions/checkout@v4
        
      - name: Node.js環境を設定
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: ./smartthreads-backend/package-lock.json
          
      - name: 依存関係をインストール
        run: npm ci
        
      - name: TypeScript型チェック
        run: npm run build
        
      - name: ESLintチェック
        run: npm run lint || true
        
      - name: ユニットテスト実行
        run: npm run test || true
        env:
          DB_HOST: localhost
          DB_PORT: 5432
          DB_USERNAME: postgres
          DB_PASSWORD: testpassword
          DB_DATABASE: smartthreads_test
          REDIS_HOST: localhost
          REDIS_PORT: 6379
          JWT_SECRET: test-secret-key
          
      - name: E2Eテスト実行
        run: npm run test:e2e || true
        env:
          DB_HOST: localhost
          DB_PORT: 5432
          DB_USERNAME: postgres
          DB_PASSWORD: testpassword
          DB_DATABASE: smartthreads_test
          REDIS_HOST: localhost
          REDIS_PORT: 6379
          JWT_SECRET: test-secret-key

  docker-build:
    name: Dockerイメージビルドテスト
    runs-on: ubuntu-latest
    needs: [test-frontend, test-backend]
    
    steps:
      - name: コードをチェックアウト
        uses: actions/checkout@v4
        
      - name: フロントエンドDockerイメージビルド
        run: |
          cd smartthreads-frontend
          docker build -t smartthreads-frontend:test .
          
      - name: バックエンドDockerイメージビルド
        run: |
          cd smartthreads-backend
          docker build -t smartthreads-backend:test .