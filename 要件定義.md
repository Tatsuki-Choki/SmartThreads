# 要件定義書: Threads投稿・削除 モバイルWebアプリ (MVP)

作成日: 2025-08-10(日)
版数: v1.0
作成: タツキ様発注用ドラフト (エンジニア向け)

---

## 1. 背景と目的

* Threads運用において、スマホ中心で「投稿作成・予約」「投稿一覧取得」「不要投稿の削除」を安全かつ高速に行えるツールを提供する。
* 複数アカウント運用時の作業時間を短縮し、ヒューマンエラーやAPI制限起因の失敗を最小化する。

## 2. スコープ

### 2.1 対象範囲

* 対象SNS: Threads (Metaの公式API前提)
* 端末: iOS/Androidのモダンブラウザ、PWAとしてホーム追加可能
* 機能: アカウント連携、投稿作成、予約、予約一覧編集・取消、公開済み一覧取得、削除、ログ閲覧、通知

### 2.2 非スコープ

* 返信、ハイライト、メッセージング、詳細なインサイト分析は将来拡張の候補としMVPでは対象外
* デスクトップ最適化UIは最小限の対応

## 3. 用語定義

* 資格情報: CLIENT\_ID, CLIENT\_SECRET, ACCESS\_TOKEN
* 予約投稿: 指定日時に自動で公開される投稿
* 公開済み投稿: 既にThreads上に存在する自アカウントの投稿
* BYO: ユーザーが自前のMetaアプリ資格情報を持ち込む運用

## 4. 前提・制約

* ユーザーは初回オンボーディングでCLIENT\_ID, CLIENT\_SECRET, ACCESS\_TOKENを入力し、アカウントをアプリと紐付ける。
* スコープ名や細目はMetaの最新ドキュメントに準拠し、仕様変更時は追随可能な設計とする。
* 投稿の文字数やメディア仕様などはAPI準拠。サーバ側でバリデーション値を環境変数で管理し、将来変更に即応する。
* レート制限に対応するため、キュー処理とスロット制御を実装する。

## 5. 利用者と権限ロール

* 管理者: 全設定と全操作、監査ログ閲覧
* 編集者: 投稿作成、予約、取消、削除
* 閲覧者: 一覧閲覧のみ
* ロールはアカウント単位で付与。監査のため操作ユーザーIDを全イベントに付与。

## 6. ユーザーストーリー (抜粋)

* US-01: 運用担当として、CLIENT\_ID等を入力して自分のThreadsアカウントを連携したい。検証が自動で行われ、成功可否が即時に分かること。
* US-02: 運用担当として、本文と画像を指定し、未来の日時で予約投稿したい。予約の状態も追跡したい。
* US-03: 運用担当として、公開済み投稿の一覧を期間やキーワードで検索し、不要な投稿を安全確認を経て削除したい。
* US-04: 運用リーダーとして、失敗やトークン失効などの重要イベントを通知で受け取りたい。

## 7. 機能要件

### F-01 オンボーディングと連携

* 入力項目: CLIENT\_ID, CLIENT\_SECRET, ACCESS\_TOKEN, タイムゾーン(既定は Asia/Tokyo)
* バリデーション: 前後空白・改行トリム、最小長、危険文字拒否、形式チェック
* サーバ検証: 有効性、権限、未失効、プロフィール取得の疎通
* 成功時: アカウントカード作成、ダッシュボードへ遷移
* 失敗時: 原因別メッセージ (資格情報不正、権限不足、失効、アプリ設定不備、ネットワーク)
* セキュリティ: 値はフロントに保持しない。保存時はKMSで暗号化。表示は末尾4文字のみマスキング。

### F-02 アカウント管理

* 一覧: 紐付け済みアカウントの表示 (表示名、threads\_user\_id、トークン期限、権限充足)
* 操作: ヘルスチェック、資格情報のローテーション、資格情報の削除 (即時失効処理)

### F-10 投稿作成

* 入力: 本文(サーバ設定の上限)、画像・動画の添付(枚数/容量上限は環境変数で制御)
* 補助: 文字数カウンタ、ドラフト自動保存、URLプレビュー、添付の自動再圧縮とExif除去
* バリデーション: 予約時刻が現在以降、拡張子・容量・解像度などAPI準拠

### F-12 予約投稿

* モード: 即時投稿、日時指定投稿
* 予約キュー: 予約時刻、対象アカウント、本文、メディア参照を登録
* 編集/取消: 予約一覧から再編集または取消可能

### F-13 予約一覧

* 表示: サムネ、本文先頭、予定時刻、状態(待機中/実行中/失敗/完了)
* 操作: 検索(日付、本文、状態)、一括取消、再試行

### F-14 予約実行ワーカー

* 動作: 分粒度でキュー監視、時刻到来で投稿API呼出
* 失敗時: 指数バックオフで最大3回再試行。恒久失敗は通知とログ化
* レート制限: スロットリング、予約再配置、ユーザーへの可視化

### F-20 公開済み投稿一覧

* 取得: 期間、キーワード、メディア有無などでフィルタ
* ページング: カーソル方式
* 表示: 投稿日時、本文先頭、メディア、permalink

### F-21 投稿削除

* 操作: 単件削除と複数選択の一括削除
* 確認: 確認ダイアログに注意喚起チェックを含む
* 結果: 成功・失敗をトースト通知、監査ログに記録

### F-30 ログと監査

* 実行ログ: 予約実行、APIレスポンス要約、再試行履歴
* 監査ログ: 誰がいつ何をしたか (機密値は記録しない)
* 保持: 期間は環境変数で設定 (既定180日)

### F-31 通知

* 種別: 予約成功/失敗、トークン期限迫近、失効、異常検知
* 方式: アプリ内通知、メール通知。将来拡張でWebhookも許容

### F-40 設定

* タイムゾーン、言語、通知設定、UIスケール

## 8. 非機能要件

* セキュリティ: TLS、KMS暗号化、最小権限、2要素認証、CSP、XSS/CSRF対策
* 可用性: 目標SLO 成功率99.9%、予約実行の平均遅延1分以内
* 性能: モバイルLCP2.5秒以内、主要操作のTTI3秒以内
* スケーラビリティ: ジョブワーカー水平拡張、キュー分割
* 観測性: 分散トレース、メトリクス、構造化ログ
* アクセシビリティ: コントラストAA、フォント可変、スクリーンリーダー配慮
* 国際化: i18n対応、日時と数値のローカライズ
* ブラウザ: iOS Safari 16.4以上、Chrome Android 114以上を推奨
* PWA: オフライン時は下書き保存と後送機能、バックグラウンド同期

## 9. UI/UX要件

* 片手操作最適化。主要CTAは親指リーチ内に配置
* スクリーン一覧:

  1. ウェルカム
  2. 資格情報入力
  3. 検証進行
  4. 連携完了
  5. ダッシュボード
  6. 投稿作成
  7. 予約一覧
  8. 公開済み一覧
  9. ログ
  10. 設定
* コンポーネント: テキストエリア、メディアピッカー、日時ピッカー、トースト、バナー、無限スクロールリスト
* 状態設計: 空状態、読み込み、成功、エラー、再試行
* マイクロコピーは短く行動を促す表現に統一

## 10. API仕様概要 (MVP)

* 認証: セッショントークン + ロール付与。外部API呼出はサーバ側で代理実行
* エンドポイント:

  * POST /v1/accounts/link
  * GET /v1/accounts/{accountId}/health
  * DELETE /v1/accounts/{accountId}/credentials
  * POST /v1/scheduled-posts
  * GET /v1/scheduled-posts
  * PATCH /v1/scheduled-posts/{scheduledPostId}
  * DELETE /v1/scheduled-posts/{scheduledPostId}
  * GET /v1/published-posts
  * DELETE /v1/published-posts/{postId}
  * POST /v1/media-assets/presign
* エラーフォーマット: { code, message, details?, retryAfter? }
* 冪等性: 予約作成はIdempotency-Keyヘッダを受け付ける
* 監査用ヘッダ: X-Actor-Id, X-Request-Id
* 追補: OpenAPI 3.1の完全定義は別紙で納品可能

## 11. データモデル (要約)

* users(id, name, email, tz, role)
* accounts(id, threads\_user\_id, display\_name, icon\_url)
* credentials(account\_id, client\_id\_enc, client\_secret\_enc, access\_token\_enc, scopes, expires\_at, last\_verified\_at, byo\_mode)
* media\_assets(id, owner\_account\_id, type, storage\_url, meta)
* scheduled\_posts(id, account\_id, text, media\_refs, scheduled\_at, status, error)
* published\_posts\_cache(id, account\_id, external\_post\_id, permalink, created\_at)
* jobs(id, type, payload, run\_at, attempts, last\_error)
* audit\_logs(id, actor, action, target, timestamp, details)
* インデックス: scheduled\_posts.scheduled\_at, published\_posts\_cache.created\_at など
* 暗号化: credentials.\* はカラム暗号化、監査ログに機密は保存しない

## 12. アーキテクチャ

* フロント: Next.js + PWA
* バックエンド: Node.js (NestJS) もしくは Python (FastAPI)
* ジョブ: Redis + BullMQ等
* DB: PostgreSQL
* ストレージ: S3互換
* 監視: OpenTelemetry, エラートラッキング
* デプロイ: コンテナ化、ステージングと本番を分離、Feature Flag運用

## 13. テスト計画

* 単体: バリデーション、ヘルパー、API疑似
* 結合: アカウント連携〜ダッシュボード
* E2E: 主要ユーザーフロー (連携、予約、取消、削除)
* 負荷: 予約同時実行、一覧スクロール
* セキュリティ: CSRF/XSS/SSRF、権限昇格、機密情報露出防止
* UAT: 受け入れ条件に準拠

## 14. ログ設計と監視

* 構造化ログ: level, timestamp, actor, action, target, result, latency
* メトリクス: 予約成功率、再試行率、平均遅延、APIエラーレート
* アラート: 閾値超過で通知 (Slackやメール)

## 15. 運用・保守

* 資格情報ローテーションガイドをアプリ内ヘルプに掲載
* トークン期限の事前通知 (72時間、24時間、1時間前)
* 事故対応: 影響範囲特定、ロールバック、事後レポート
* バックアップ/復元: DBは日次スナップショット、復旧手順を用意

## 16. リスクと対応

* API仕様変更: バリデーション閾値を環境変数化し影響を局所化、監視で早期検知
* レート制限: キュー分散、待機スロット、ユーザー通知
* トークン失効: 自動ヘルスチェックと事前通知、代替資格情報の登録手順
* 時刻同期: NTPでサーバ時刻を保持、タイムゾーンはユーザー設定を優先

## 17. スケジュール案 (例)

* スプリント1: 2025-08-11(月) 〜 2025-08-15(金)

  * アーキ設計、DB/キュー雛形、アカウント連携API、資格情報UI
* スプリント2: 2025-08-18(月) 〜 2025-08-22(金)

  * 予約投稿APIとUI、ジョブワーカー、ログ基盤
* スプリント3: 2025-08-25(月) 〜 2025-08-29(金)

  * 公開済み一覧取得、削除、一括操作、通知
* スプリント4: 2025-09-01(月) 〜 2025-09-05(金)

  * 負荷・セキュリティ・UAT、ドキュメント整備、リリース

## 18. 受け入れ条件 (抜粋)

* 連携完了からダッシュボード表示まで10秒以内
* 予約成功率99.9%、平均遅延1分以内
* 削除は2タップ以内で確認付きで実行される
* モバイルでLCP2.5秒以内、主要操作で致命的エラーがない

## 19. 付録 A: API例 (抜粋)

* POST /v1/accounts/link

  * req: { clientId, clientSecret, accessToken, tz }
  * res: { accountId, threadsUserId, displayName, iconUrl, verifiedAt, scopes }
* POST /v1/scheduled-posts

  * req: { accountId, text, media\[], schedule{ mode, at? } }
  * res: { scheduledPostId, status, scheduledAt }
* GET /v1/published-posts

  * query: accountId, from, to, q, cursor
  * res: { items\[], nextCursor }
* DELETE /v1/published-posts/{postId}

  * res: { deleted: true }

## 20. 付録 B: 画面別UI要件 (詳細)

* 資格情報入力: クリップボード貼付最適化、可視切替、即時バリデーション、フィールド単位のエラー表示
* 予約作成: 文字数カウンタ、日時ピッカーはTZ反映、下書き自動保存、失敗理由の可視化
* 一覧系: 無限スクロール、骨組み表示、空状態のガイド
* アクセシビリティ: ラベルとヒントの関連付け、フォーカス管理、キーボード操作

## 21. 付録 C: データ保持・プライバシーポリシー草案

* 機密情報は暗号化。ユーザーの明示操作で削除可能
* ログは運用目的に限定し、期限で自動削除